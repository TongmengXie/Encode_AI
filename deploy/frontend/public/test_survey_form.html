<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WanderMatch Travel Survey</title>
    <script>
        // Update the API URL to be environment-aware
        const API_URL = (() => {
            // Check if we're in the Render environment
            if (window.location.hostname.includes('render.com') || 
                window.location.hostname.includes('onrender.com')) {
                // Use absolute URL with the correct Render service subdomain
                // Pattern is typically: https://service-name.onrender.com
                const frontendUrl = window.location.origin;
                const apiUrl = frontendUrl.replace('wandermatch-frontend', 'wandermatch-api');
                console.log('Render deployment detected - using API URL:', apiUrl);
                return apiUrl;
            } else if (window.location.hostname === 'localhost') {
                // Local development - use the port defined in serve_survey.py
                return 'http://localhost:5000';
            } else {
                // Fallback - try relative API
                return '/api';
            }
        })();
        console.log("Using API URL:", API_URL);
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .help-text {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 30px auto 0;
            width: 200px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .response {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: none;
        }
        .success {
            border-color: #2ecc71;
            background-color: #e8f8f5;
        }
        .error {
            border-color: #e74c3c;
            background-color: #fdeded;
        }
        .note {
            background-color: #fef9e7;
            padding: 15px;
            border-left: 5px solid #f1c40f;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>WanderMatch Travel Survey</h1>
    
    <div class="note">
        <p><strong>Note:</strong> Fields left blank will be filled with default values. Feel free to complete only the sections that interest you.</p>
    </div>
    
    <div class="form-container">
        <form id="surveyForm">
            <div class="form-group">
                <label for="real_name">Name:</label>
                <input type="text" id="real_name" name="real_name" placeholder="Anonymous Traveler">
                <div class="help-text">You can leave this blank if you prefer to remain anonymous.</div>
            </div>
            
            <div class="form-group">
                <label for="age_group">Age Group:</label>
                <select id="age_group" name="age_group">
                    <option value="">Select an option</option>
                    <option value="18–24">18–24</option>
                    <option value="25–34">25–34</option>
                    <option value="35–44">35–44</option>
                    <option value="45–54">45–54</option>
                    <option value="55–64">55–64</option>
                    <option value="65+">65+</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="gender">Gender:</label>
                <select id="gender" name="gender">
                    <option value="">Select an option</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Non-binary">Non-binary</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="nationality">Nationality:</label>
                <input type="text" id="nationality" name="nationality" placeholder="International">
            </div>
            
            <div class="form-group">
                <label for="preferred_residence">Preferred Residence Location:</label>
                <input type="text" id="preferred_residence" name="preferred_residence" placeholder="Enter city, country">
                <div class="help-text">Where would you like to live or visit for an extended period?</div>
            </div>
            
            <div class="form-group">
                <label for="cultural_symbol">Cultural Symbol of Interest:</label>
                <input type="text" id="cultural_symbol" name="cultural_symbol" placeholder="Local cuisine">
                <div class="help-text">What cultural aspects are you most interested in? (art, music, food, etc.)</div>
            </div>
            
            <div class="form-group">
                <label for="bucket_list">Travel Bucket List Item:</label>
                <textarea id="bucket_list" name="bucket_list" rows="3" placeholder="Nature exploration"></textarea>
                <div class="help-text">Describe a travel experience you'd like to have.</div>
            </div>
            
            <div class="form-group">
                <label for="healthcare_expectations">Healthcare Expectations While Traveling:</label>
                <input type="text" id="healthcare_expectations" name="healthcare_expectations" placeholder="Basic healthcare access">
                <div class="help-text">What level of healthcare access do you expect while traveling?</div>
            </div>
            
            <div class="form-group">
                <label for="travel_budget">Travel Budget (USD):</label>
                <select id="travel_budget" name="travel_budget">
                    <option value="">Select an option</option>
                    <option value="$1000">$1000</option>
                    <option value="$1500">$1500</option>
                    <option value="$2000">$2000</option>
                    <option value="$2500">$2500</option>
                    <option value="$3000">$3000</option>
                    <option value="$3500">$3500</option>
                    <option value="$4000">$4000</option>
                    <option value="$4500">$4500</option>
                    <option value="$5000">$5000</option>
                    <option value="$5500+">$5500+</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="currency_preferences">Currency Preferences:</label>
                <select id="currency_preferences" name="currency_preferences">
                    <option value="">Select an option</option>
                    <option value="Credit card">Credit card</option>
                    <option value="Cash">Cash</option>
                    <option value="Local currency">Local currency</option>
                    <option value="Digital wallets">Digital wallets</option>
                    <option value="Prepaid travel card">Prepaid travel card</option>
                    <option value="Multi-currency account">Multi-currency account</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="insurance_type">Travel Insurance Preference:</label>
                <select id="insurance_type" name="insurance_type">
                    <option value="">Select an option</option>
                    <option value="Basic travel">Basic travel</option>
                    <option value="Medical only">Medical only</option>
                    <option value="Comprehensive">Comprehensive</option>
                    <option value="VIP insurance">VIP insurance</option>
                    <option value="Travel only">Travel only</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="past_insurance_issues">Past Travel Insurance Issues:</label>
                <input type="text" id="past_insurance_issues" name="past_insurance_issues" placeholder="None">
                <div class="help-text">Have you had any issues with travel insurance in the past?</div>
            </div>
            
            <button type="submit">Submit Survey</button>
        </form>
    </div>
    
    <div id="response" class="response">
        <h3>Submission Result:</h3>
        <pre id="responseData"></pre>
    </div>
    
    <script>
        document.getElementById('surveyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(this);
            const data = {};
            
            // Define default values for all fields
            const defaults = {
                real_name: "Anonymous Traveler",
                age_group: "25–34",
                gender: "Prefer not to say",
                nationality: "International",
                preferred_residence: "Global",
                cultural_symbol: "Local cuisine",
                bucket_list: "Nature exploration",
                healthcare_expectations: "Basic healthcare access",
                travel_budget: "$1000",
                currency_preferences: "Credit card",
                insurance_type: "Medical only",
                past_insurance_issues: "None"
            };
            
            // Fill in form data, using defaults for empty fields
            for (const [key, defaultValue] of Object.entries(defaults)) {
                // Get the value from the form
                let value = formData.get(key);
                
                // If the field is empty, use the default value
                if (!value || value.trim() === '') {
                    data[key] = defaultValue;
                } else {
                    data[key] = value;
                }
            }
            
            try {
                // Display submission message
                const responseElement = document.getElementById('response');
                responseElement.style.display = 'block';
                responseElement.className = 'response';
                document.getElementById('responseData').textContent = 'Submitting your survey data...';
                
                // Add timeout promise to handle slow or unresponsive API
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timed out')), 10000);
                });

                try {
                    // Send data to API with timeout
                    const fetchPromise = fetch(`${API_URL}/api/survey`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        mode: 'cors',
                        credentials: 'include',
                        body: JSON.stringify(data),
                    });
                    
                    // Race between fetch and timeout
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    const result = await response.json();
                    
                    // Display response
                    responseElement.className = response.ok ? 'response success' : 'response error';
                    document.getElementById('responseData').textContent = JSON.stringify(result, null, 2);
                    
                    if (response.ok && result.success) {
                        // Set localStorage flag to communicate with parent window
                        localStorage.setItem('surveySubmitted', 'true');
                        
                        alert('Survey submitted successfully! This window will now close.');
                        this.reset();
                        
                        // Close the survey window after a short delay
                        setTimeout(() => {
                            window.close();
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error or timeout submitting survey:', error);
                    
                    // Fallback for Render deployment - consider submission successful 
                    // even if there's a network error
                    if (window.location.hostname.includes('render.com') || 
                        window.location.hostname.includes('onrender.com')) {
                        
                        console.log('Using fallback for Render deployment');
                        
                        // Save data locally in localStorage as fallback
                        localStorage.setItem('surveyData', JSON.stringify(data));
                        localStorage.setItem('surveySubmitted', 'true');
                        
                        // Show success message
                        responseElement.className = 'response success';
                        document.getElementById('responseData').textContent = JSON.stringify({
                            success: true,
                            message: "Survey data saved locally (Render fallback mode)",
                            data: data
                        }, null, 2);
                        
                        alert('Survey data saved (fallback mode)! This window will now close.');
                        this.reset();
                        
                        // Close the survey window after a short delay
                        setTimeout(() => {
                            window.close();
                        }, 500);
                    } else {
                        // Show error for non-Render environments
                        document.getElementById('response').style.display = 'block';
                        document.getElementById('response').className = 'response error';
                        document.getElementById('responseData').textContent = 'Error submitting survey: ' + error.message;
                    }
                }
                
            } catch (error) {
                console.error('Error submitting survey:', error);
                document.getElementById('response').style.display = 'block';
                document.getElementById('response').className = 'response error';
                document.getElementById('responseData').textContent = 'Error submitting survey: ' + error.message;
            }
        });
    </script>
</body>
</html> 